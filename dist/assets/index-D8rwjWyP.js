var e=Object.defineProperty,t=(t,s,i)=>((t,s,i)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[s]=i)(t,"symbol"!=typeof s?s+"":s,i);import{p as s,P as i}from"./phaser-hyM8z1KO.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver((e=>{for(const s of e)if("childList"===s.type)for(const e of s.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)})).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const r="Preloader",a="MainMenu",n="Game",o="DebugUIScene",l="barrel",h="assets",c="physics",d=1/0,u=1/0,g="waiting_to_start",m="playing",p="game_over",f="level_complete";class y extends s.Scene{constructor(){super("Boot")}preload(){}create(){console.log("Boot: create"),this.scene.start(r)}}const x=e=>"coin"===e.label,b=e=>"duck"===e.label,v=e=>"finish"===e.label,w=e=>"enemy"===e.label,E=e=>"fallSensor"===e.label;function L(e){return e.label===l}let B=0,P=0;const C=()=>B;let D=0;const I=()=>D;class A{constructor(e,s){t(this,"scene"),t(this,"camera"),this.scene=e,this.camera=this.scene.cameras.main,this.setupCamera(s)}setupBounds(){this.scene.matter.world.setBounds(0,0,1e4,4e3),this.camera.setBounds(0,0,1e4,4e3)}setupCamera(e){this.setupBounds(),this.camera.startFollow(e,!0,.5,.5),this.camera.setLerp(.5,.5),this.camera.setZoom(1.5)}handleZoomIn(){this.scene.tweens.add({targets:this.camera,zoom:2,duration:700,ease:"Power2"})}}const S="COIN_IDLE",M="COIN_COLLECT",R={COIN_IDLE:{prefix:"coin/coin-idle/coin-idle-",frames:23,loop:-1,frameRate:30},COIN_COLLECT:{prefix:"coin/coin-collect/coin-collect-",frames:8,loop:0,frameRate:30}};class N extends Phaser.Physics.Matter.Sprite{constructor(e,t,s){const i=e.cache.json.get(c);super(e.matter.world,t,s,h,R[S].prefix+"0001.png",{shape:i.coin,isStatic:!0,isSensor:!0}),this.play(S),e.add.existing(this)}collect(){this.play(M),this.scene.matter.world.remove(this),this.once(Phaser.Animations.Events.ANIMATION_COMPLETE,(()=>{var e;(null==(e=this.anims.currentAnim)?void 0:e.key)===M&&this.destroy(!0)}))}}const G=e=>{var t;const s=(null==(t=e.label)?void 0:t.toLowerCase())??"";return["platform","crate-big","crate-small"].includes(s)},k={ENEMY_IDLE:{prefix:"enemy/enemy.png",frames:10,loop:0,frameRate:0}},O=class e extends Phaser.Physics.Matter.Sprite{constructor(e,s,i){const r=e.cache.json.get(c);super(e.matter.world,s,i,h,k.ENEMY_IDLE.prefix,{shape:r.enemy}),t(this,"speed",1.4),t(this,"direction",1),t(this,"platformBounds"),e.add.existing(this),e.matter.world.on("collisionstart",this.handleCollisionStart,this),this.setFixedRotation()}handleGameOver(){this.setVelocity(0,0)}update(){if(!this.platformBounds)return;this.setVelocity(this.speed*this.direction,0);const{left:e,right:t}=this.getBounds(),{left:s,right:i}=this.platformBounds;t>=i&&1===this.direction?this.direction=-1:e<=s&&-1===this.direction&&(this.direction=1)}handleCollisionStart(t){if(this.platformBounds)return;const s=this.body,i=s.id,r=s.parts?s.parts.map((e=>e.id)):[i];r.includes(i)||r.push(i);for(const{bodyA:a,bodyB:n}of t.pairs){let t=null,s=null;if(r.includes(a.id)&&G(n)?(t=a,s=n):r.includes(n.id)&&G(a)&&(t=n,s=a),t&&s){const t=s.id,i=e.platformCache.get(t);if(i)this.platformBounds=i;else{const{min:i,max:r}=s.bounds,a={left:i.x,right:r.x};e.platformCache.set(t,a),this.platformBounds=a}this.scene.matter.world.off("collisionstart",this.handleCollisionStart,this);break}}}};t(O,"platformCache",new Map);let F=O;const T={CRATE_BIG_IDLE:{prefix:"crate/crate-big.png",frames:1,loop:0,frameRate:0}};class _ extends Phaser.Physics.Matter.Sprite{constructor(e,t,s){const i=e.cache.json.get(c);super(e.matter.world,t,s,h,T.CRATE_BIG_IDLE.prefix,{shape:i["crate-big"]}),e.add.existing(this)}}const X={CRATE_SMALL_IDLE:{prefix:"crate/crate-small.png",frames:1,loop:0,frameRate:0}};class U extends Phaser.Physics.Matter.Sprite{constructor(e,t,s){const i=e.cache.json.get(c);super(e.matter.world,t,s,h,X.CRATE_SMALL_IDLE.prefix,{shape:i["crate-small"]}),e.add.existing(this)}}const z={BARREL_IDLE:{prefix:"barrel/launch/barrel-launch-0010",frames:1,loop:0,frameRate:0},BARREL_ENTER:{prefix:"barrel/enter/barrel-enter-",frames:19,loop:0,frameRate:30},BARREL_LAUNCH:{prefix:"barrel/launch/barrel-launch-",frames:10,loop:0,frameRate:30}};class V extends Phaser.Physics.Matter.Sprite{constructor(e,s,i){const r=e.cache.json.get(c);super(e.matter.world,s,i,h,void 0,{shape:r[l],isStatic:!0,isSensor:!0}),t(this,"isEntered",!1),this.angle=-90,this.setOrigin(.22,.5),this.play("BARREL_IDLE"),e.add.existing(this)}update(){this.isEntered&&(this.angle+=2)}enter(){this.play("BARREL_ENTER"),this.isEntered=!0}launch(){if(!this.isEntered)return null;this.play("BARREL_LAUNCH"),this.isEntered=!1;const e=Phaser.Math.DegToRad(this.angle);return new Phaser.Math.Vector2(15*Math.cos(e),15*Math.sin(e))}}function $(e,t,s,i){const r=t.getBounds(),a=r.width;let n=0;const o=Math.floor(a/80),l=s.nextInt(0,o+1);if(l>0){const t=(a-80*(l-1))/2,s=r.top-14-5;for(let a=0;a<l;a++){const o=r.left+t+80*a,l=16;if(Math.abs(o-r.centerX)<l)continue;const h=new N(e,o,s);i.push(h),n++}}return n}const H={LEFT:{prefix:"platforms/platform-left.png",frames:1,loop:0,frameRate:0},RIGHT:{prefix:"platforms/platform-right.png",frames:1,loop:0,frameRate:0},MIDDLE:{prefix:"platforms/platform-middle.png",frames:1,loop:0,frameRate:0}};class j extends Phaser.Physics.Matter.Sprite{constructor(e,s,i,r,a){((e,t,s)=>{if(e.textures.exists(s)){const i=e.make.renderTexture({width:26*t,height:24},!1);return i.draw(s,0,0),i}(function(e,t,s){const i=e.make.container({x:0,y:0,add:!1}),r=26*t,a=e.make.image({key:h,frame:H.LEFT.prefix,x:13,y:12,add:!1}),n=e.make.tileSprite({key:h,frame:H.MIDDLE.prefix,x:26*t/2,y:13.5,width:26*(t-2),height:24,add:!1}),o=e.make.image({key:h,frame:H.RIGHT.prefix,x:r-13,y:12,add:!1});i.add([a,n,o]);const l=e.make.renderTexture({width:r,height:24},!1);l.draw(i),l.saveTexture(s),i.destroy()})(e,t,s)})(e,r,a);const n=e.cache.json.get(c).platform,{collisionFilter:o}=n,l={label:"platform",isStatic:n.isStatic,collisionFilter:{category:o.category,group:o.group,mask:o.mask}};super(e.matter.world,s,i,a,void 0,l),t(this,"segmentCount"),this.segmentCount=r,e.add.existing(this)}}const K="FX_LAND",Y={FX_LAND:{prefix:"fx-land/fx-land-",frames:18,loop:0,frameRate:30}};class W extends Phaser.GameObjects.Sprite{constructor(e,t,s){super(e,t,s,h,Y[K].prefix+"0001.png"),this.setScale(.3),this.play(K),e.add.existing(this),this.once(Phaser.Animations.Events.ANIMATION_COMPLETE,(()=>{var e;(null==(e=this.anims.currentAnim)?void 0:e.key)===K&&this.destroy(!0)}))}}const J="DUCK_FALL",Z="DUCK_IDLE",Q="DUCK_JUMP",q="DUCK_LAND",ee="DUCK_BLAST",te="DUCK_WOBBLE",se={DUCK_FALL:{prefix:"player/fall/duck-fall-",frames:10,loop:0,frameRate:30},DUCK_DEAD:{prefix:"player/dead/duck-dead-",frames:10,loop:0,frameRate:30},DUCK_IDLE:{prefix:"player/idle/duck-idle-",frames:10,loop:0,frameRate:30},DUCK_JUMP:{prefix:"player/jump/duck-jump-",frames:12,loop:0,frameRate:30},DUCK_RUN:{prefix:"player/run/duck-run-",frames:14,loop:-1,frameRate:30},DUCK_LAND:{prefix:"player/land/duck-land-",frames:56,loop:0,frameRate:30},DUCK_BLAST:{prefix:"player/blast/duck-blast-",frames:19,loop:0,frameRate:30},DUCK_WOBBLE:{prefix:"player/wobble/duck-wobble-",frames:22,loop:-1,frameRate:30}};class ie extends Phaser.Physics.Matter.Sprite{constructor(e,s,i){const r=e.cache.json.get(c);super(e.matter.world,s,i,h,se[Z].prefix+"0001.png",{shape:r["duck-idle"]}),t(this,"cursors"),t(this,"wasd"),t(this,"isGrounded",!1),t(this,"groundContacts",new Set),t(this,"currentAnimKey",""),t(this,"isAlive",!0),t(this,"isLevelComplete",!1),t(this,"currentBarrel",null),t(this,"recentlyExitedBarrel",!1),t(this,"canEnterBarrels",!0),t(this,"isInBarrel",!1),t(this,"upIsDown",!1),t(this,"rightIsDown",!1),t(this,"leftIsDown",!1),t(this,"isPlayingLandAnimation",!1),t(this,"isNearEdge",!1),t(this,"isNearLeftEdge",!1),t(this,"isNearRightEdge",!1),t(this,"currentPlatformBounds",null),e.matter.world.on("collisionstart",this.handleCollisionStart,this),e.matter.world.on("collisionend",this.handleCollisionEnd,this),this.setFixedRotation(),this.setupControls(),this.playAnimation(Z,!0),this.isAlive=!0,this.isInBarrel=!1,this.currentBarrel=null,this.recentlyExitedBarrel=!1,this.canEnterBarrels=!0,this.isPlayingLandAnimation=!1,this.isNearEdge=!1,this.isNearLeftEdge=!1,this.isNearRightEdge=!1,this.currentPlatformBounds=null,e.add.existing(this)}setupControls(){var e,t;this.scene.sys.game.device.os.desktop&&(this.cursors=null==(e=this.scene.input.keyboard)?void 0:e.createCursorKeys(),this.wasd=null==(t=this.scene.input.keyboard)?void 0:t.addKeys("W,A,D"))}update(){var e;if(this.isAlive)if(this.getVelocity().x<0?this.flipX=!0:this.getVelocity().x>0&&(this.flipX=!1),this.isInBarrel)this.handleInBarrelState();else{if(this.isGrounded?this.checkIfNearEdge():(this.isNearEdge=!1,this.isNearLeftEdge=!1,this.isNearRightEdge=!1),this.scene.sys.game.device.input.touch||(this.leftIsDown=this.cursors.left.isDown||this.wasd.A.isDown||!1,this.rightIsDown=this.cursors.right.isDown||this.wasd.D.isDown||!1,this.upIsDown=this.cursors.up.isDown||this.wasd.W.isDown||!1),!this.isLevelComplete&&(null==(e=this.anims.currentAnim)?void 0:e.key)!==ee&&(this.leftIsDown&&this.setVelocity(-3,this.body.velocity.y),this.rightIsDown&&this.setVelocity(3,this.body.velocity.y),!this.isGrounded||this.leftIsDown||this.rightIsDown||this.setVelocity(0,0),this.upIsDown&&!this.isInBarrel&&this.isGrounded))return this.setVelocityY(-12),this.playAnimation(Q,!0),void this.once(Phaser.Animations.Events.ANIMATION_COMPLETE,(()=>{this.isGrounded||this.playAnimation(J,!0)}));this.isGrounded||this.currentAnimKey===Q||this.currentAnimKey===ee?this.isGrounded&&(!this.isNearEdge||this.leftIsDown||this.rightIsDown?this.leftIsDown||this.rightIsDown||this.currentAnimKey===q?(this.leftIsDown||this.rightIsDown)&&this.playAnimation("DUCK_RUN"):this.playAnimation(Z,!1):(this.playAnimation(te),this.isNearLeftEdge&&!this.isNearRightEdge?this.flipX=!0:this.isNearRightEdge&&!this.isNearLeftEdge&&(this.flipX=!1)),this.isLevelComplete&&this.playAnimation(Z,!1)):this.playAnimation(J)}}checkIfNearEdge(){if(!this.isGrounded||0===this.groundContacts.size)return this.isNearEdge=!1,this.isNearLeftEdge=!1,void(this.isNearRightEdge=!1);if(!this.currentPlatformBounds&&this.groundContacts.size>0){const e=Array.from(this.groundContacts)[0];if(e&&e.bounds){const{min:t,max:s}=e.bounds;this.currentPlatformBounds={left:t.x,right:s.x}}}if(this.currentPlatformBounds){const e=this.x,t=Math.abs(e-this.currentPlatformBounds.left),s=Math.abs(this.currentPlatformBounds.right-e);this.isNearLeftEdge=t<15,this.isNearRightEdge=s<15,this.isNearEdge=this.isNearLeftEdge||this.isNearRightEdge}else this.isNearEdge=!1,this.isNearLeftEdge=!1,this.isNearRightEdge=!1}playAnimation(e,t=!1){if(this.currentAnimKey===e){if(!t)return;this.anims.stop()}this.play(e),this.currentAnimKey=e}handleCollisionStart(e){for(const{bodyA:t,bodyB:s}of e.pairs)b(t)&&G(s)?this.handleLanding(s):b(s)&&G(t)&&this.handleLanding(t);this.isGrounded=this.groundContacts.size>0,this.currentPlatformBounds=null,this.isGrounded&&new W(this.scene,this.x,this.getBounds().bottom)}handleLanding(e){if(this.groundContacts.add(e),e&&e.bounds){const{min:t,max:s}=e.bounds;this.currentPlatformBounds={left:t.x,right:s.x}}this.isGrounded||(this.recentlyExitedBarrel?(this.isPlayingLandAnimation=!0,this.playAnimation(q,!0),this.once(Phaser.Animations.Events.ANIMATION_COMPLETE,(()=>{this.isPlayingLandAnimation=!1,this.leftIsDown||this.rightIsDown||(this.checkIfNearEdge(),this.isNearEdge?(this.playAnimation(te,!1),this.isNearLeftEdge&&!this.isNearRightEdge?this.flipX=!0:this.isNearRightEdge&&!this.isNearLeftEdge&&(this.flipX=!1)):this.playAnimation(Z,!1))}))):this.anims.currentAnim.key!==q&&(this.checkIfNearEdge(),!this.isNearEdge||this.leftIsDown||this.rightIsDown?this.playAnimation(Z,!1):(this.playAnimation(te,!1),this.isNearLeftEdge&&!this.isNearRightEdge?this.flipX=!0:this.isNearRightEdge&&!this.isNearLeftEdge&&(this.flipX=!1))),this.recentlyExitedBarrel=!1)}handleCollisionEnd(e){for(const{bodyA:t,bodyB:s}of e.pairs)b(t)&&G(s)?this.groundContacts.delete(s):b(s)&&G(t)&&this.groundContacts.delete(t);this.isGrounded=this.groundContacts.size>0,this.isGrounded||(this.currentPlatformBounds=null,this.isNearEdge=!1,this.isNearLeftEdge=!1,this.isNearRightEdge=!1)}handleInBarrelState(){var e,t,s,i;this.currentBarrel&&(this.setPosition(this.currentBarrel.x,this.currentBarrel.y),this.setVelocity(0,0),((null==(t=null==(e=this.cursors)?void 0:e.up)?void 0:t.isDown)||(null==(i=null==(s=this.wasd)?void 0:s.W)?void 0:i.isDown)||this.upIsDown)&&(this.currentBarrel.launch(),this.exitBarrel()))}enterBarrel(e){!this.isInBarrel&&this.body&&this.canEnterBarrels&&(this.isInBarrel=!0,this.currentBarrel=e,this.isGrounded=!1,this.isNearEdge=!1,this.isNearLeftEdge=!1,this.isNearRightEdge=!1,this.currentPlatformBounds=null,this.setStatic(!0),this.setVisible(!1),this.currentBarrel.enter())}exitBarrel(){if(console.log("[Player] exitBarrel called"),!this.isInBarrel||!this.currentBarrel||!this.body)return;const e=this.currentBarrel.angle;this.isInBarrel=!1,this.currentBarrel=null,this.setStatic(!1),this.setVisible(!0);const t=Phaser.Math.Vector2.RIGHT.clone().rotate(Phaser.Math.DegToRad(e)).scale(14);this.setVelocity(t.x,t.y),this.flipX=t.x<0,this.playAnimation(ee,!0);const s=(e%360+360)%360;s>90&&s<270?this.setRotation(Phaser.Math.DegToRad(e+180)):this.setRotation(Phaser.Math.DegToRad(e)),this.once(Phaser.Animations.Events.ANIMATION_COMPLETE,(()=>{this.playAnimation(J,!1),this.setRotation(0),this.setFlipY(!1)})),this.recentlyExitedBarrel=!0,this.canEnterBarrels=!1,this.scene.time.delayedCall(300,(()=>{this.canEnterBarrels=!0}))}finishLevel(){this.isLevelComplete=!0,this.setVelocityX(0),this.isInBarrel&&this.exitBarrel()}kill(){this.isAlive=!1,this.isInBarrel&&this.exitBarrel(),this.playAnimation("DUCK_DEAD"),this.setVelocityX(0),this.setVelocityY(0),this.setStatic(!0)}}const re={FINISH_IDLE:{prefix:"finish/finish-idle/finish-idle",frames:1,loop:0,frameRate:0},FINISH_ACTIVATED:{prefix:"finish/finish-activated/finish-activated-",frames:19,loop:0,frameRate:30},FINISH_ACTIVE:{prefix:"finish/finish-active/finish-active-",frames:8,loop:-1,frameRate:30}};class ae extends Phaser.Physics.Matter.Sprite{constructor(e,s,i){const r=e.cache.json.get(c);super(e.matter.world,s,i,h,void 0,{shape:r.finish,isStatic:!0,isSensor:!0}),t(this,"isActivated",!1),this.setOrigin(.3,.5),this.play("FINISH_IDLE"),e.add.existing(this)}activate(){this.isActivated||(this.play("FINISH_ACTIVATED"),this.isActivated=!0)}}class ne{constructor(e){t(this,"seed"),this.seed=e}next(){let e=this.seed+=1831565813;return e=Math.imul(e^e>>>15,1|e),e^=e+Math.imul(e^e>>>7,61|e),((e^e>>>14)>>>0)/4294967296}nextInt(e,t){return Math.floor(this.next()*(t-e)+e)}choice(e){return e[this.nextInt(0,e.length)]}}class oe{constructor(e,s){t(this,"scene"),t(this,"levelNumber"),t(this,"prng"),t(this,"platforms",[]),t(this,"coins",[]),t(this,"enemies",[]),t(this,"crates",[]),t(this,"barrels",[]),t(this,"player"),t(this,"levelMinX",0),t(this,"levelMaxX",0),t(this,"levelLowestY",0),t(this,"PLATFORM_DISPLAY_HEIGHT",32),t(this,"bridgeBarrelRanges",[]),this.scene=e,this.levelNumber=s,this.prng=new ne(this.levelNumber)}generateLevel(){const e=oe.calculateLevelGenerationParams(this.levelNumber),t=this.prng.nextInt(e.minPlatforms,e.maxPlatforms+1);let s=180,i=300,r=0,a=null;const n=[];this.platforms=[],this.enemies=[],this.coins=[],this.crates=[],this.barrels=[],this.bridgeBarrelRanges=[],this.createPlayerStart({x:s,y:i});const o=this.prng.nextInt(e.minPlatformLength,e.maxPlatformLength+1),l=this.createPlatform({x:s,y:i},o,0);a=l;for(let c=1;c<t;c++){let o=this.prng.nextInt(e.minPlatformLength,e.maxPlatformLength+1);const{nextX:l,nextY:h,dX:d}=this.calculateNextPlatformPosition({x:s,y:i},o,a,e);let u=!1,g=0,m=0,p=null;if(d>e.maxHorizontalGap&&c<t-1){g=a.getBounds().right+d/2,p={start:g-20,end:g+20};let e=!1;for(const t of this.bridgeBarrelRanges)if(p.start<t.end&&p.end>t.start){e=!0;break}if(e)console.warn(`  Overlap detected for bridge barrel at X=${g.toFixed(0)}. Placing platform instead.`);else{const e=10;m=a.getBounds().top+24+e,m=Math.min(m,1/0),u=!0}}if(u){console.log(`Impossible gap detected (dX=${d.toFixed(0)} > maxJump=${e.maxHorizontalGap}). Placing barrel.`);const t=new V(this.scene,g,m);this.barrels.push(t),this.bridgeBarrelRanges.push(p),s=g+this.prng.nextInt(e.minHorizontalGap,e.maxHorizontalGap+1),console.log(`  Placed barrel at (${g.toFixed(0)}, ${m.toFixed(0)}). Next platform target X: ${s.toFixed(0)}`)}else{const e=this.createPlatform({x:l,y:h},o,c);r+=$(this.scene,e,this.prng,this.coins),n.push(e),a=e,s=l,i=h}}const h=n.filter((e=>e!==a));return function(e,t,s,i,r,a){if(0===t.length)return;const n=(e=>{for(let t=e.length-1;t>0;t--){const i=s.nextInt(0,t+1);[e[t],e[i]]=[e[i],e[t]]}return e})([...t]),o=i.targetEnemies,l=i.targetCrates,h=o+l,c=n.slice(0,Math.min(h,n.length)),d=new Set;let u=0,g=0;for(let m=0;m<c.length&&u<o;m++){if(d.has(m))continue;const t=c[m];if(t.segmentCount>=6){const s=t.getBounds(),i=s.centerX,a=s.top-20-14,n=new F(e,i,a);r.push(n),u++,d.add(m)}}for(let m=0;m<c.length&&g<l;m++){if(d.has(m))continue;const t=c[m].getBounds(),i=t.centerX,r=s.next()<.5,n=r?64:32,o=t.top-n/2,l=r?new _(e,i,o):new U(e,i,o);a.push(l),g++,d.add(m)}}(this.scene,h,this.prng,e,this.enemies,this.crates),this.createFinishPoint(a),this.calculateOverallBounds(),console.log(`Level generated with ${this.platforms.length} platforms, ${this.enemies.length} enemies, ${this.crates.length} crates, ${this.barrels.length} barrels, ${r} coins.`),P=r,this.player}static calculateLevelGenerationParams(e){const t=10+e,s=15+e,i=.3+Math.min(.3,.02*e),r=.25+Math.min(.2,.01*e),a=.15+Math.min(.1,.01*e),n=(t+s)/2,o=Math.floor(n*i),l=Math.floor(n*r);let h=Math.floor(n*a);h=Math.max(1,h);const c=o+l+h+2,d=Math.max(t,c);return{minPlatforms:d,maxPlatforms:Math.max(d,s),minPlatformLength:4,maxPlatformLength:12,minHorizontalGap:120,maxHorizontalGap:150,minVerticalGap:-120,maxVerticalGap:400,enemyProbability:i,crateProbability:r,barrelProbability:a,requiredCoins:100,targetEnemies:o,targetCrates:l,targetBarrels:h}}createPlayerStart(e){this.player=new ie(this.scene,e.x,e.y-50-this.PLATFORM_DISPLAY_HEIGHT/2)}calculateNextPlatformPosition(e,t,s,i){let r=e.x,a=e.y,n=0,o=0;if(s){const e=s.getBounds(),l=32*t/2,h=1.2*i.maxHorizontalGap;n=this.prng.nextInt(i.minHorizontalGap,h+1),o=this.prng.nextInt(i.minVerticalGap,i.maxVerticalGap+1),Math.abs(o)<20&&(o=o>=0?20:-20,o=Phaser.Math.Clamp(o,i.minVerticalGap,i.maxVerticalGap)),r=e.right+n+l,a=s.y+o;const c=100,d=1/0;a=Phaser.Math.Clamp(a,c,d),o=a-s.y}else console.error("calculateNextPlatformPosition called without lastPlatform!");return{nextX:r,nextY:a,dX:n,dY:o}}createPlatform(e,t,s){const i=new j(this.scene,e.x,e.y,t,0===s?"start":s===t-1?"end":"middle");return this.platforms.push(i),i}createFinishPoint(e){if(!e)return;const t=e.getBounds(),s=t.right-40,i=t.top-45;new ae(this.scene,s,i)}calculateOverallBounds(){if(0===this.platforms.length)return this.levelMinX=0,this.levelMaxX=1e3,this.levelLowestY=1/0,void console.warn("LevelGenerator: No platforms generated, using default bounds.");const e=this.platforms[0].getBounds();this.levelMinX=e.left,this.levelMaxX=e.right,this.levelLowestY=e.bottom;for(let t=1;t<this.platforms.length;t++){const e=this.platforms[t].getBounds();this.levelMinX=Math.min(this.levelMinX,e.left),this.levelMaxX=Math.max(this.levelMaxX,e.right),this.levelLowestY=Math.max(this.levelLowestY,e.bottom)}}getEnemies(){return this.enemies}getPlatforms(){return this.platforms}getCoins(){return this.coins}removeCoin(e){this.coins=this.coins.filter((t=>t!==e))}getCrates(){return this.crates}getBarrels(){return this.barrels}getOverallLevelBounds(){return{minX:this.levelMinX,maxX:this.levelMaxX,lowestY:this.levelLowestY}}}class le extends i.GameObjects.TileSprite{constructor(e,s,i,r,a,n=.5){super(e,0,0,r,a,s,i),t(this,"customScrollFactorX"),this.customScrollFactorX=n,this.setOrigin(0,0),this.setScrollFactor(0,0),e.add.existing(this)}update(){this.tilePositionX=this.scene.cameras.main.scrollX*this.customScrollFactorX}}class he{constructor(e){t(this,"scene"),t(this,"backgroundLayer"),t(this,"middleLayer"),t(this,"foregroundLayer"),t(this,"levelWidth",0),t(this,"bgScrollFactorX"),t(this,"midScrollFactorX"),t(this,"fgScrollFactorX"),t(this,"createLayer",((e,t,s,i,r,a)=>{const n=this.scene.scale.height,o=this.scene.textures.getFrame(e,t);o||console.error(`Frame '${t}' not found in atlas '${e}'`);const l=o.height*r,h=n-l+i,c=new le(this.scene,e,t,this.levelWidth,l,a);return c.y=h,c.setDepth(s),c})),this.scene=e}initialize(e){this.levelWidth=Math.max(e,this.scene.scale.width),this.createLayers()}createLayers(){this.bgScrollFactorX=.2,this.midScrollFactorX=1.5,this.fgScrollFactorX=2,this.backgroundLayer=this.createLayer(h,"bg/background.png",-3,-220,1,this.bgScrollFactorX),this.middleLayer=this.createLayer(h,"bg/middle-ground.png",-2,-250,1,this.midScrollFactorX),this.foregroundLayer=this.createLayer(h,"bg/foreground.png",3,-180,1,this.fgScrollFactorX)}update(){this.backgroundLayer&&this.middleLayer&&this.foregroundLayer&&(this.backgroundLayer.update(),this.middleLayer.update(),this.foregroundLayer.update())}}class ce extends s.Scene{constructor(){super(n),t(this,"player"),t(this,"overlayButton"),t(this,"restartTriggered",!1),t(this,"physicsEnabled",!1),t(this,"gameState",g),t(this,"enemies",[]),t(this,"barrels",[]),t(this,"cameraManager"),t(this,"levelGenerator"),t(this,"parallaxManager"),t(this,"totalBarrelsGenerated",0),t(this,"culledBarrelsCount",0),t(this,"physicsDebugActive",!1),t(this,"debugGraphics"),t(this,"initialPhysicsDebugState",!1),t(this,"handleCollisionStart",(({pairs:e})=>{if(this.physicsEnabled)for(const{bodyA:t,bodyB:s}of e){if(this.checkFallSensorCollision(t,s))return;if(this.checkEnemyCollision(t,s))return;if(this.checkFinishCollision(t,s))return;if(this.checkCoinCollision(t,s))return;if(this.checkBarrelCollision(t,s))return}}))}create(){this.restartTriggered=!1,this.parallaxManager=new he(this),this.setupWorldBounds(),this.initGame(),this.showUIOverlay(g),this.createDebugUI(),this.sys.game.device.input.touch&&this.createMobileControls()}createDebugUI(){this.debugGraphics&&this.debugGraphics.destroy(),this.debugGraphics=this.add.graphics().setAlpha(1).setDepth(9999),this.matter.world.debugGraphic=this.debugGraphics,this.matter.world.drawDebug=this.initialPhysicsDebugState,this.physicsDebugActive=this.initialPhysicsDebugState,this.debugGraphics.setVisible(this.initialPhysicsDebugState),this.game.events.on("togglePhysicsDebug",this.togglePhysicsDebug,this),this.scene.isActive(o)||this.scene.launch(o)}setupWorldBounds(){this.matter.world.setBounds(0,0,d,u),this.matter.world.enabled=!1}initGame(){if(B=0,P=0,D=0,0===I()&&(D=1),this.enemies=[],this.barrels=[],this.generateLevelEntities(),this.setupCollisions(),!this.player)throw new Error("Player not created during level generation!");this.cameraManager=new A(this,this.player)}generateLevelEntities(){const e=I();this.levelGenerator=new oe(this,e),this.player=this.levelGenerator.generateLevel(),this.enemies=this.levelGenerator.getEnemies(),this.barrels=this.levelGenerator.getBarrels(),this.totalBarrelsGenerated=this.barrels.length;const t=this.levelGenerator.getOverallLevelBounds(),{minX:s,maxX:i,lowestY:r}=t,a=s===-1/0?0:s,n=i===1/0?a:i,o=Math.max(n-a,this.scale.width);this.parallaxManager&&this.parallaxManager.initialize(o);const l=o+1e3,h=a+(n-a)/2;this.createFallSensor(r,h,l)}showUIOverlay(e,t=!0){if(this.overlayButton&&(this.overlayButton.off("pointerup"),this.overlayButton.destroy(),this.overlayButton=void 0),e===m)return void(this.gameState=e);const s=this.game.canvas.width/2,i=this.game.canvas.height/2;let r,a;switch(e){case g:r="ui/start.png",a=()=>{var e;null==(e=this.overlayButton)||e.destroy(),this.overlayButton=void 0,this.startGame()};break;case p:r="ui/game-over.png",a=()=>{this.restartTriggered||this.restartLevel()};break;case f:r="ui/start.png",a=()=>{this.restartTriggered||this.restartLevel()};break;default:return}this.overlayButton=this.add.image(s,i,h,r).setOrigin(.5).setScrollFactor(0).setDepth(1e3).setInteractive({useHandCursor:!0}),t&&(this.overlayButton.setAlpha(0),this.tweens.add({targets:this.overlayButton,alpha:1,duration:400,ease:"Power2"})),this.overlayButton.on("pointerup",a),this.gameState=e}togglePhysicsDebug(){this.physicsDebugActive=!this.physicsDebugActive,this.matter.world.drawDebug=this.physicsDebugActive,this.debugGraphics.setVisible(this.physicsDebugActive)}startGame(){this.gameState=m,this.matter.world.enabled=!0,this.physicsEnabled=!0}createFallSensor(e,t,s){const i=e+500+50;this.matter.add.rectangle(t,i,s,100,{isSensor:!0,isStatic:!0,label:"fallSensor",collisionFilter:{group:0,category:16,mask:23}})}setupCollisions(){this.matter.world.on("collisionstart",this.handleCollisionStart)}checkFallSensorCollision(e,t){return!!(E(e)&&b(t)||E(t)&&b(e))&&(this.handleGameOver(),!0)}checkEnemyCollision(e,t){return!!(w(e)&&b(t)||w(t)&&b(e))&&(this.handleGameOver(),!0)}checkFinishCollision(e,t){return!!(v(e)&&b(t)||v(t)&&b(e))&&(v(e)?e.gameObject.activate():v(t)&&t.gameObject.activate(),this.handleLevelComplete(),!0)}checkCoinCollision(e,t){return x(e)&&b(t)?(this.collectCoin(e),!0):!(!x(t)||!b(e)||(this.collectCoin(t),0))}collectCoin(e){const t=e.gameObject;var s;t&&(this.levelGenerator.removeCoin(t),t.collect(),s=C()+1,B=s)}update(){if(this.parallaxManager.update(),!this.physicsEnabled)return;this.player.update(),this.enemies.forEach((e=>e.update()));const e=this.cameras.main,t=new s.Geom.Rectangle(e.worldView.x-100,e.worldView.y-100,e.worldView.width+200,e.worldView.height+200);let i=0,r=0;this.levelGenerator.getCoins().forEach((e=>{const r=s.Geom.Rectangle.Overlaps(t,e.getBounds());e.setVisible(r),e.setActive(r),r||i++})),this.enemies.forEach((e=>{const i=s.Geom.Rectangle.Overlaps(t,e.getBounds());e.setVisible(i),e.setActive(i),i||r++})),this.culledBarrelsCount=0,this.barrels.forEach((e=>{const i=s.Geom.Rectangle.Overlaps(t,e.getBounds());e.setVisible(i),e.setActive(i),i?e.update():this.culledBarrelsCount++}));const a={PlayerPos:{x:Math.round(this.player.x),y:Math.round(this.player.y)},Platforms:this.levelGenerator.getPlatforms().length,Enemies:this.enemies.length,CulledEnemies:r,Coins:this.levelGenerator.getCoins().length,CulledCoins:i,Crates:this.levelGenerator.getCrates().length,Barrels:this.totalBarrelsGenerated,CulledBarrels:this.culledBarrelsCount};this.events.emit("updateDebugData",a)}handleGameOver(){this.gameState===m&&(this.player.kill(),this.physicsEnabled=!1,this.enemies.forEach((e=>e.handleGameOver())),this.cameraManager.handleZoomIn(),this.showUIOverlay(p))}createMobileControls(){console.log("Creating mobile controls"),this.createMobileButton(100,800,(()=>this.player.leftIsDown=!0),(()=>this.player.leftIsDown=!1),{angle:0}),this.createMobileButton(300,800,(()=>this.player.rightIsDown=!0),(()=>this.player.rightIsDown=!1),{angle:-180}),this.createMobileButton(1100,800,(()=>this.player.upIsDown=!0),(()=>this.player.upIsDown=!1),{angle:90})}createMobileButton(e,t,s,i,{angle:r}){const a=this.add.image(e,t,h,"ui/direction-button.png").setScrollFactor(1).setInteractive().setAngle(r).setDepth(1e4);return a.on("pointerdown",(()=>{s()})),a.on("pointerup",(()=>{i()})),a}handleLevelComplete(){this.gameState===m&&(this.player.finishLevel(),((e=1)=>{D+=e})(1),this.enemies.forEach((e=>e.handleGameOver())),this.cameraManager.handleZoomIn(),this.showUIOverlay(f))}restartLevel(){if(this.restartTriggered)return;this.restartTriggered=!0;const e=this.physicsDebugActive;console.log(`[Game] Restarting level. Passing debug state: ${e}`),this.matter.world?this.matter.world.off("collisionstart",this.handleCollisionStart):console.warn("[Game] Matter world not found during restart cleanup."),this.game.events.off("togglePhysicsDebug",this.togglePhysicsDebug,this),this.scene.isActive(o)&&(console.log("[Game Restart] Stopping Debug UI scene."),this.scene.stop(o)),this.scene.restart({physicsDebugWasActive:e})}checkBarrelCollision(e,t){let s=null,i=null;if(b(e)&&L(t)?(s=e,i=t):b(t)&&L(e)&&(s=t,i=e),s&&i){const e=i.gameObject;if(e&&!this.player.isInBarrel&&this.player.canEnterBarrels)return console.log("[Game] Player collided with barrel",e),this.player.enterBarrel(e),!0}return!1}}class de extends s.Scene{constructor(){super(a),t(this,"background"),t(this,"logo"),t(this,"playButton")}create(){const{width:e,height:t}=this.scale;let s;this.background=this.add.image(e/2,t/2,h,"ui/main-menu/background.png"),s=e/t>this.background.width/this.background.height?e/this.background.width:t/this.background.height,this.background.setScale(s).setScrollFactor(0),this.logo=this.add.image(e/2,.4*t,h,"ui/main-menu/title.png"),this.playButton=this.add.image(e/2,.6*t,h,"ui/main-menu/play-game.png").setInteractive({useHandCursor:!0}),this.playButton.on("pointerdown",(()=>{this.scene.start(n)}))}}function ue(e,t,s){Object.entries(s).forEach((([s,i])=>{i.frames<=1?e.create({key:s,frames:[{key:t,frame:`${i.prefix}.png`}],repeat:0}):e.create({key:s,frames:e.generateFrameNames(t,{prefix:i.prefix,start:1,end:i.frames,zeroPad:4,suffix:".png"}),repeat:i.loop,frameRate:i.frameRate})}))}class ge extends s.Scene{constructor(){super(r),t(this,"loadingText",null)}init(){const e=this.cameras.main.centerX,t=this.cameras.main.centerY;this.add.rectangle(e,t,468,32).setStrokeStyle(1,16777215);const s=this.add.rectangle(e-234+2+2,t,4,28,16777215);this.loadingText=this.add.text(e,t-32-50,"Loading: 0%",{fontFamily:"Arial",fontSize:"50px",color:"#ffffff"}).setOrigin(.5),this.load.on("progress",(e=>{var t;s.width=Math.round(4+460*e),null==(t=this.loadingText)||t.setText(`Loading: ${Math.round(100*e)}%`)}))}preload(){this.load.setPath("assets"),this.load.multiatlas(h,"assets.json"),this.load.json(c,"physics.json")}create(){var e;this.setupAnimations(),null==(e=this.loadingText)||e.destroy(!0),this.loadingText=null,this.scene.start(a)}setupAnimations(){ue(this.game.anims,h,se),ue(this.game.anims,h,R),ue(this.game.anims,h,re),ue(this.game.anims,h,Y),ue(this.game.anims,h,z)}}class me{constructor(e,s,i){t(this,"scene"),t(this,"text"),t(this,"active",!1),this.scene=e,this.text=this.scene.add.text(s,i,"Debug Panel (Press Q)",{fontSize:"24px",color:"#ffffff",backgroundColor:"rgba(0,0,0,0.7)",padding:{x:8,y:5}}),this.text.setOrigin(1,0),this.text.setScrollFactor(0),this.text.setDepth(100),this.text.setVisible(this.active),this.scene.scale.on("resize",this.handleResize,this),this.handleResize()}handleResize(){const e=this.scene.scale.width-10;this.text.setPosition(e,10);const t=Math.min(this.scene.scale.displayScale.x,this.scene.scale.displayScale.y),s=Math.max(12,Math.round(24*t));this.text.setFontSize(`${s}px`)}toggle(){this.active=!this.active,this.text.setVisible(this.active)}update(e){if(!this.active)return;let t=`FPS: ${Math.round(this.scene.game.loop.actualFps)}\nDebug Panel (Q)\n-----------------\n`;const s=["PlayerPos","Platforms","Enemies","CulledEnemies","Coins","CulledCoins","Crates","Barrels","CulledBarrels"];for(const i of s)if(Object.prototype.hasOwnProperty.call(e,i)){const s=e[i];t+="PlayerPos"===i&&"object"==typeof s&&null!==s?`${i}: x=${Math.round(s.x)}, y=${Math.round(s.y)}\n`:"number"==typeof s?`${i}: ${s}\n`:`${i}: ${JSON.stringify(s)}\n`,delete e[i]}for(const i in e)if(Object.prototype.hasOwnProperty.call(e,i)){const s=e[i];t+=`${i}: ${JSON.stringify(s)}\n`}this.text.setText(t)}destroy(){this.scene.scale.off("resize",this.handleResize,this),this.text.destroy()}}class pe{constructor(e){t(this,"scene"),t(this,"text"),this.scene=e,this.text=this.scene.add.text(16,16,"Coins: 0 / 0",{fontFamily:"Roboto",fontSize:"36px",color:"#ffffff",stroke:"#000000",strokeThickness:3}).setOrigin(0,0).setScrollFactor(0).setDepth(100),this.scene.scale.on("resize",this.handleResize,this)}handleResize(){this.text.setPosition(16,16)}update(){this.text.setText(`Coins: ${C()} / ${P}`)}destroy(){this.scene.scale.off("resize",this.handleResize,this),this.text.destroy()}}class fe{constructor(e){t(this,"scene"),t(this,"text"),this.scene=e,this.text=this.scene.add.text(16,72,"Level: 0",{fontFamily:"Roboto",fontSize:"36px",color:"#ffffff",stroke:"#000000",strokeThickness:3}).setOrigin(0,0).setScrollFactor(0).setDepth(100),this.scene.scale.on("resize",this.handleResize,this),this.handleResize()}handleResize(){this.text.setPosition(16,72);const e=Math.min(this.scene.scale.displayScale.x,this.scene.scale.displayScale.y),t=Math.max(12,Math.round(36*e));this.text.setFontSize(`${t}px`)}update(){this.text.setText("Level: "+I())}destroy(){this.scene.scale.off("resize",this.handleResize,this),this.text.destroy()}}class ye extends i.Scene{constructor(){super(o),t(this,"debugPanel"),t(this,"coinUI"),t(this,"levelUI")}create(){var e;console.log("DebugUIScene created"),this.debugPanel=new me(this,this.scale.width-10,10),this.coinUI=new pe(this),this.levelUI=new fe(this);const t=this.scene.get(n);t&&(t.events.on("updateDebugData",this.handleDebugDataUpdate,this),this.events.on(i.Scenes.Events.SHUTDOWN,(()=>{console.log("DebugUIScene shutting down, removing listener"),t.events.off("updateDebugData",this.handleDebugDataUpdate,this),this.levelUI.destroy(),this.coinUI.destroy()}))),null==(e=this.input.keyboard)||e.on("keydown-Q",(()=>{this.debugPanel.toggle(),this.game.events.emit("togglePhysicsDebug")}))}handleDebugDataUpdate(e){this.debugPanel.update(e)}update(){this.coinUI.update(),this.levelUI.update()}}const xe={type:Phaser.AUTO,width:1920,height:1080,parent:"game-container",backgroundColor:"#028af8",scale:{mode:Phaser.Scale.EXPAND,autoCenter:Phaser.Scale.CENTER_BOTH},physics:{default:"matter",matter:{gravity:{x:0,y:1},debug:{showAxes:!1,showAngleIndicator:!0,showBounds:!1,showCollisions:!0,showConvexHulls:!0,showInternalEdges:!1,showPositions:!0,showSeparation:!1,showVelocity:!0,renderFill:!0,renderLine:!0,lineColor:65280,fillColor:65280,fillOpacity:.1,lineOpacity:1,lineThickness:1,staticFillColor:255,staticLineColor:255}}},scene:[y,ge,de,ce,ye]},be=()=>{window.innerWidth<window.innerHeight?(console.log("Portrait"),addEventListener("resize",be)):(removeEventListener("resize",be),console.log("Landscape"),new s.Game(xe))};window.innerWidth<window.innerHeight?(console.log("Portrait"),addEventListener("resize",be)):(console.log("Landscape"),new s.Game(xe));
